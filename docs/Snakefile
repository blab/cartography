rule all:
    input:
        "cartography.pdf",
        #"cartography.html",
        "total_HDBSCAN_table.csv"

rule concat_HDBSCAN_tables:
    input:
        Flu_KDE = "../seasonal-flu-nextstrain/results/full_HDBSCAN_metadata.csv",
        Zika_KDE = "../zika-nextstrain/results/full_HDBSCAN_metadata.csv",
        MERS_KDE = "../mers-nextstrain/results/full_HDBSCAN_metadata.csv",
        SARS_KDE = "../sars-cov-2-nextstrain/results/full_HDBSCAN_metadata.csv"
    output:
        fullKDE = "total_HDBSCAN_table.csv",
        table = "total_HDBSCAN_table.txt"
    params:
        disease_names = "Influenza Zika MERS Sars-CoV-2",
        dataframes = "../seasonal-flu-nextstrain/results/full_HDBSCAN_metadata.csv ../zika-nextstrain/results/full_HDBSCAN_metadata.csv ../mers-nextstrain/results/full_HDBSCAN_metadata.csv ../sars-cov-2-nextstrain/results/full_HDBSCAN_metadata.csv"
    conda: "../cartography.yml"
    shell:
        """
        python3 ../notebooks/scripts/concat_KDE_tables.py \
            --tables {params.dataframes} \
            --output-csv {output.fullKDE} \
            --output-table {output.table} \
            --disease-names {params.disease_names}
        """

rule manuscript_pdf:
    input:
        manuscript="cartography.tex",
        bibliography="cartography.bib",
    output:
        manuscript = "cartography.pdf",
    conda: "../cartography.yml"
    shell:
        """
        pdflatex -draftmode {input.manuscript};
        bibtex cartography;
        pdflatex -draftmode {input.manuscript};
        pdflatex {input.manuscript};
        """

rule manuscript_html:
    input:
        manuscript = "cartography.md",
        bibliography = "cartography.bib",
        csl = "chicago-author-date.csl",
        template = "pandoc-scholar.html",
        css = "pandoc-scholar.css"
    output:
        manuscript = "cartography.html"
    conda: "../cartography.yml"
    shell:
        """
        pandoc \
            --filter pandoc-crossref \
            --citeproc \
            --bibliography={input.bibliography} \
            --csl {input.csl} \
            --template {input.template} \
            --css {input.css} \
            --from markdown+link_attributes \
            -s {input.manuscript} \
            -o {output.manuscript}
        """


#pandoc --filter pandoc-crossref --citeproc --bibliography=cartography.bib --csl chicago-author-date.csl --template pandoc-scholar.html --css pandoc-scholar.css -s cartography.md -o cartography.html
